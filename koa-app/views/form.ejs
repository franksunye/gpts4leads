<!-- views/form.ejs -->

<%- include('partials/header', { title: 'Form Submission' }) %>
<%- include('partials/navbar') %>

<div class="container">
    <h1>Form Submission</h1>
    <p>This is the form data list for the current form.</p>

    <!-- 表格开始 -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Form Data</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-vcenter">
                    <thead>
                        <tr>
                            <th>UUID</th>
                            <% fields.forEach(function(field) { %>
                                <th><%= field.Name %></th>
                            <% }); %>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% formData.forEach(function(data) { %>
                            <tr>
                                <td><%= data.UUID %></td>
                                <% fields.forEach(function(field) { %>
                                    <td><%= data[field.Name] %></td>
                                <% }); %>
                                <td><%= data.CreatedAt %></td>
                                <td>
                                    <button class="btn btn-link" data-toggle="modal" data-target="#deleteModal" data-uuid="<%= data.UUID %>">Delete</button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    <!-- 显示条目数量 -->
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div style="margin-left: 20px; color: #6c757d;">
                    Showing <%= (page - 1) * limit + 1 %> to <%= Math.min(page * limit, total) %> of <%= total %> entries
                </div>
            </div>
            <div class="col-md-6" style="text-align: right;">
                <div style="margin-right: 20px;">
<!-- 分页导航 -->
<nav aria-label="Page navigation example">
    <ul class="pagination">
        <!-- 修改Prev按钮，使其在第一页时变为不可点击 -->
        <li class="page-item <%= page === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="<%= page === 1 ? '#' : '/submissions/' + tenantUuid + '/form/' + formUuid + '?page=' + (page - 1) %>">< prev</a>
        </li>
        <% const maxPagesToShow = 10; %>
        <% const startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2)); %>
        <% const endPage = Math.min(totalPages, startPage + maxPagesToShow - 1); %>
        <% for (let i = startPage; i <= endPage; i++) { %>
            <li class="page-item <%= i === page ? 'active' : '' %>">
                <a class="page-link" href="/submissions/<%= tenantUuid %>/form/<%= formUuid %>?page=<%= i %>"><%= i %></a>
            </li>
        <% } %>
        <!-- 修改Next按钮，使其在最后一页时变为不可点击 -->
        <li class="page-item <%= page === totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="<%= page === totalPages ? '#' : '/submissions/' + tenantUuid + '/form/' + formUuid + '?page=' + (page + 1) %>">next ></a>
        </li>
    </ul>
</nav>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
       <div class="modal-content">
         <div class="modal-header">
           <h5 class="modal-title" id="deleteModalLabel">Delete Confirmation</h5>
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
             <span aria-hidden="true">&times;</span>
           </button>
         </div>
         <div class="modal-body">
           Are you sure you want to delete this data?
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
           <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
         </div>
       </div>
    </div>
</div>
<div id="alertMessage" class="alert alert-success" style="display: none;"></div>

<script>
    let currentUUID;
    document.querySelectorAll('[data-toggle="modal"]').forEach(button => {
        button.addEventListener('click', function(event) {
            currentUUID = event.target.dataset.uuid; // 存储当前要删除的数据的ID
        });
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
        if (currentUUID) {
            fetch(`/formData/${currentUUID}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                localStorage.setItem('alertMessage', 'Data deleted successfully');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('alertMessage').textContent = 'Error deleting data';
                document.getElementById('alertMessage').style.display = 'block';
            });
        }
            // Manually hide the modal
        let deleteModal = document.getElementById('deleteModal');
        deleteModal.classList.remove('show');
        deleteModal.setAttribute('aria-hidden', 'true');
        deleteModal.setAttribute('style', 'display: none');
        document.body.classList.remove('modal-open');
        let modalBackdrop = document.getElementsByClassName('modal-backdrop')[0];
        modalBackdrop.parentNode.removeChild(modalBackdrop);
    });

    window.onload = function() {
    const alertMessage = localStorage.getItem('alertMessage');
    if (alertMessage) {
        // 显示alert消息
        document.getElementById('alertMessage').textContent = alertMessage;
        document.getElementById('alertMessage').style.display = 'block';
        // 在一段时间后自动消失
        setTimeout(function() {
            document.getElementById('alertMessage').style.display = 'none';
            // 清除本地存储中的alert消息
            localStorage.removeItem('alertMessage');
        }, 5000);
    }
};
</script>
<%- include('partials/footer') %>